{"cells":[{"cell_type":"code","source":["import pyspark\nfrom graphframes import GraphFrame\nfrom pyspark.sql.functions import desc, expr\n"],"metadata":{},"outputs":[{"metadata":{},"output_type":"display_data","data":{"text/html":["<style scoped>\n  .ansiout {\n    display: block;\n    unicode-bidi: embed;\n    white-space: pre-wrap;\n    word-wrap: break-word;\n    word-break: break-all;\n    font-family: \"Source Code Pro\", \"Menlo\", monospace;;\n    font-size: 13px;\n    color: #555;\n    margin-left: 4px;\n    line-height: 19px;\n  }\n</style>\n<div class=\"ansiout\"></div>"]}}],"execution_count":1},{"cell_type":"code","source":["%sh \ncurl -O \"https://raw.githubusercontent.com/databricks/Spark-The-Definitive-Guide/master/data/bike-data/201508_station_data.csv\"\ncurl -O \"https://raw.githubusercontent.com/databricks/Spark-The-Definitive-Guide/master/data/bike-data/201508_trip_data.csv\""],"metadata":{},"outputs":[{"metadata":{},"output_type":"display_data","data":{"text/html":["<style scoped>\n  .ansiout {\n    display: block;\n    unicode-bidi: embed;\n    white-space: pre-wrap;\n    word-wrap: break-word;\n    word-break: break-all;\n    font-family: \"Source Code Pro\", \"Menlo\", monospace;;\n    font-size: 13px;\n    color: #555;\n    margin-left: 4px;\n    line-height: 19px;\n  }\n</style>\n<div class=\"ansiout\">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current\n                                 Dload  Upload   Total   Spent    Left  Speed\n\n  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0\n100  5272  100  5272    0     0  14924      0 --:--:-- --:--:-- --:--:-- 14934\n  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current\n                                 Dload  Upload   Total   Spent    Left  Speed\n\n  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0\n  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0\n100 41.0M  100 41.0M    0     0  36.7M      0  0:00:01  0:00:01 --:--:-- 36.8M\n</div>"]}}],"execution_count":2},{"cell_type":"code","source":["%fs ls \"file:/databricks/driver\""],"metadata":{},"outputs":[{"metadata":{},"output_type":"display_data","data":{"text/html":["<style scoped>\n  .table-result-container {\n    max-height: 300px;\n    overflow: auto;\n  }\n  table, th, td {\n    border: 1px solid black;\n    border-collapse: collapse;\n  }\n  th, td {\n    padding: 5px;\n  }\n  th {\n    text-align: left;\n  }\n</style><div class='table-result-container'><table class='table-result'><thead style='background-color: white'><tr><th>path</th><th>name</th><th>size</th></tr></thead><tbody><tr><td>file:/databricks/driver/conf/</td><td>conf/</td><td>4096</td></tr><tr><td>file:/databricks/driver/201508_station_data.csv</td><td>201508_station_data.csv</td><td>5272</td></tr><tr><td>file:/databricks/driver/logs/</td><td>logs/</td><td>4096</td></tr><tr><td>file:/databricks/driver/derby.log</td><td>derby.log</td><td>726</td></tr><tr><td>file:/databricks/driver/eventlogs/</td><td>eventlogs/</td><td>4096</td></tr><tr><td>file:/databricks/driver/201508_trip_data.csv</td><td>201508_trip_data.csv</td><td>43012650</td></tr><tr><td>file:/databricks/driver/ganglia/</td><td>ganglia/</td><td>4096</td></tr></tbody></table></div>"]}}],"execution_count":3},{"cell_type":"code","source":["# load datasets\nbikeStations = spark.read.option(\"header\", \"true\")\\\n  .csv(\"file:/databricks/driver/201508_station_data.csv\")\n\ntripData = spark.read.option(\"header\", \"true\")\\\n  .csv(\"file:/databricks/driver/201508_trip_data.csv\")"],"metadata":{},"outputs":[{"metadata":{},"output_type":"display_data","data":{"text/html":["<style scoped>\n  .ansiout {\n    display: block;\n    unicode-bidi: embed;\n    white-space: pre-wrap;\n    word-wrap: break-word;\n    word-break: break-all;\n    font-family: \"Source Code Pro\", \"Menlo\", monospace;;\n    font-size: 13px;\n    color: #555;\n    margin-left: 4px;\n    line-height: 19px;\n  }\n</style>\n<div class=\"ansiout\"></div>"]}}],"execution_count":4},{"cell_type":"code","source":["bikeStations.head(5)"],"metadata":{},"outputs":[{"metadata":{},"output_type":"display_data","data":{"text/html":["<style scoped>\n  .ansiout {\n    display: block;\n    unicode-bidi: embed;\n    white-space: pre-wrap;\n    word-wrap: break-word;\n    word-break: break-all;\n    font-family: \"Source Code Pro\", \"Menlo\", monospace;;\n    font-size: 13px;\n    color: #555;\n    margin-left: 4px;\n    line-height: 19px;\n  }\n</style>\n<div class=\"ansiout\">Out[4]: [Row(station_id=&#39;2&#39;, name=&#39;San Jose Diridon Caltrain Station&#39;, lat=&#39;37.329732&#39;, long=&#39;-121.901782&#39;, dockcount=&#39;27&#39;, landmark=&#39;San Jose&#39;, installation=&#39;8/6/2013&#39;),\n Row(station_id=&#39;3&#39;, name=&#39;San Jose Civic Center&#39;, lat=&#39;37.330698&#39;, long=&#39;-121.888979&#39;, dockcount=&#39;15&#39;, landmark=&#39;San Jose&#39;, installation=&#39;8/5/2013&#39;),\n Row(station_id=&#39;4&#39;, name=&#39;Santa Clara at Almaden&#39;, lat=&#39;37.333988&#39;, long=&#39;-121.894902&#39;, dockcount=&#39;11&#39;, landmark=&#39;San Jose&#39;, installation=&#39;8/6/2013&#39;),\n Row(station_id=&#39;5&#39;, name=&#39;Adobe on Almaden&#39;, lat=&#39;37.331415&#39;, long=&#39;-121.8932&#39;, dockcount=&#39;19&#39;, landmark=&#39;San Jose&#39;, installation=&#39;8/5/2013&#39;),\n Row(station_id=&#39;6&#39;, name=&#39;San Pedro Square&#39;, lat=&#39;37.336721&#39;, long=&#39;-121.894074&#39;, dockcount=&#39;15&#39;, landmark=&#39;San Jose&#39;, installation=&#39;8/7/2013&#39;)]</div>"]}}],"execution_count":5},{"cell_type":"code","source":["tripData.head(5)"],"metadata":{},"outputs":[{"metadata":{},"output_type":"display_data","data":{"text/html":["<style scoped>\n  .ansiout {\n    display: block;\n    unicode-bidi: embed;\n    white-space: pre-wrap;\n    word-wrap: break-word;\n    word-break: break-all;\n    font-family: \"Source Code Pro\", \"Menlo\", monospace;;\n    font-size: 13px;\n    color: #555;\n    margin-left: 4px;\n    line-height: 19px;\n  }\n</style>\n<div class=\"ansiout\">Out[5]: [Row(Trip ID=&#39;913460&#39;, Duration=&#39;765&#39;, Start Date=&#39;8/31/2015 23:26&#39;, Start Station=&#39;Harry Bridges Plaza (Ferry Building)&#39;, Start Terminal=&#39;50&#39;, End Date=&#39;8/31/2015 23:39&#39;, End Station=&#39;San Francisco Caltrain (Townsend at 4th)&#39;, End Terminal=&#39;70&#39;, Bike #=&#39;288&#39;, Subscriber Type=&#39;Subscriber&#39;, Zip Code=&#39;2139&#39;),\n Row(Trip ID=&#39;913459&#39;, Duration=&#39;1036&#39;, Start Date=&#39;8/31/2015 23:11&#39;, Start Station=&#39;San Antonio Shopping Center&#39;, Start Terminal=&#39;31&#39;, End Date=&#39;8/31/2015 23:28&#39;, End Station=&#39;Mountain View City Hall&#39;, End Terminal=&#39;27&#39;, Bike #=&#39;35&#39;, Subscriber Type=&#39;Subscriber&#39;, Zip Code=&#39;95032&#39;),\n Row(Trip ID=&#39;913455&#39;, Duration=&#39;307&#39;, Start Date=&#39;8/31/2015 23:13&#39;, Start Station=&#39;Post at Kearny&#39;, Start Terminal=&#39;47&#39;, End Date=&#39;8/31/2015 23:18&#39;, End Station=&#39;2nd at South Park&#39;, End Terminal=&#39;64&#39;, Bike #=&#39;468&#39;, Subscriber Type=&#39;Subscriber&#39;, Zip Code=&#39;94107&#39;),\n Row(Trip ID=&#39;913454&#39;, Duration=&#39;409&#39;, Start Date=&#39;8/31/2015 23:10&#39;, Start Station=&#39;San Jose City Hall&#39;, Start Terminal=&#39;10&#39;, End Date=&#39;8/31/2015 23:17&#39;, End Station=&#39;San Salvador at 1st&#39;, End Terminal=&#39;8&#39;, Bike #=&#39;68&#39;, Subscriber Type=&#39;Subscriber&#39;, Zip Code=&#39;95113&#39;),\n Row(Trip ID=&#39;913453&#39;, Duration=&#39;789&#39;, Start Date=&#39;8/31/2015 23:09&#39;, Start Station=&#39;Embarcadero at Folsom&#39;, Start Terminal=&#39;51&#39;, End Date=&#39;8/31/2015 23:22&#39;, End Station=&#39;Embarcadero at Sansome&#39;, End Terminal=&#39;60&#39;, Bike #=&#39;487&#39;, Subscriber Type=&#39;Customer&#39;, Zip Code=&#39;9069&#39;)]</div>"]}}],"execution_count":6},{"cell_type":"code","source":["# rename vertices and edges\nstationVertices = bikeStations.withColumnRenamed(\"name\", \"id\").distinct()\ntripEdges = tripData\\\n  .withColumnRenamed(\"Start Station\", \"src\")\\\n  .withColumnRenamed(\"End Station\", \"dst\")"],"metadata":{},"outputs":[{"metadata":{},"output_type":"display_data","data":{"text/html":["<style scoped>\n  .ansiout {\n    display: block;\n    unicode-bidi: embed;\n    white-space: pre-wrap;\n    word-wrap: break-word;\n    word-break: break-all;\n    font-family: \"Source Code Pro\", \"Menlo\", monospace;;\n    font-size: 13px;\n    color: #555;\n    margin-left: 4px;\n    line-height: 19px;\n  }\n</style>\n<div class=\"ansiout\"></div>"]}}],"execution_count":7},{"cell_type":"code","source":["# create graph object\nstationGraph = GraphFrame(stationVertices, tripEdges)\nstationGraph.cache()"],"metadata":{},"outputs":[{"metadata":{},"output_type":"display_data","data":{"text/html":["<style scoped>\n  .ansiout {\n    display: block;\n    unicode-bidi: embed;\n    white-space: pre-wrap;\n    word-wrap: break-word;\n    word-break: break-all;\n    font-family: \"Source Code Pro\", \"Menlo\", monospace;;\n    font-size: 13px;\n    color: #555;\n    margin-left: 4px;\n    line-height: 19px;\n  }\n</style>\n<div class=\"ansiout\">Out[7]: GraphFrame(v:[id: string, station_id: string ... 5 more fields], e:[src: string, dst: string ... 9 more fields])</div>"]}}],"execution_count":8},{"cell_type":"code","source":["print(\"Total Number of Stations: \" + str(stationGraph.vertices.count()))\nprint(\"Total Number of Trips in Grapph: \" + str(stationGraph.edges.count()))\nprint(\"Total Number of Trips in Original Data: \" + str(tripData.count()))"],"metadata":{},"outputs":[{"metadata":{},"output_type":"display_data","data":{"text/html":["<style scoped>\n  .ansiout {\n    display: block;\n    unicode-bidi: embed;\n    white-space: pre-wrap;\n    word-wrap: break-word;\n    word-break: break-all;\n    font-family: \"Source Code Pro\", \"Menlo\", monospace;;\n    font-size: 13px;\n    color: #555;\n    margin-left: 4px;\n    line-height: 19px;\n  }\n</style>\n<div class=\"ansiout\">Total Number of Stations: 70\nTotal Number of Trips in Grapph: 354152\nTotal Number of Trips in Original Data: 354152\n</div>"]}}],"execution_count":9},{"cell_type":"code","source":["# query graph\nstationGraph.edges.groupBy(\"src\", \"dst\").count().orderBy(desc(\"count\")).show(10,False)"],"metadata":{},"outputs":[{"metadata":{},"output_type":"display_data","data":{"text/html":["<style scoped>\n  .ansiout {\n    display: block;\n    unicode-bidi: embed;\n    white-space: pre-wrap;\n    word-wrap: break-word;\n    word-break: break-all;\n    font-family: \"Source Code Pro\", \"Menlo\", monospace;;\n    font-size: 13px;\n    color: #555;\n    margin-left: 4px;\n    line-height: 19px;\n  }\n</style>\n<div class=\"ansiout\">+---------------------------------------------+----------------------------------------+-----+\nsrc                                          |dst                                     |count|\n+---------------------------------------------+----------------------------------------+-----+\nSan Francisco Caltrain 2 (330 Townsend)      |Townsend at 7th                         |3748 |\nHarry Bridges Plaza (Ferry Building)         |Embarcadero at Sansome                  |3145 |\n2nd at Townsend                              |Harry Bridges Plaza (Ferry Building)    |2973 |\nTownsend at 7th                              |San Francisco Caltrain 2 (330 Townsend) |2734 |\nHarry Bridges Plaza (Ferry Building)         |2nd at Townsend                         |2640 |\nEmbarcadero at Folsom                        |San Francisco Caltrain (Townsend at 4th)|2439 |\nSteuart at Market                            |2nd at Townsend                         |2356 |\nEmbarcadero at Sansome                       |Steuart at Market                       |2330 |\nTownsend at 7th                              |San Francisco Caltrain (Townsend at 4th)|2192 |\nTemporary Transbay Terminal (Howard at Beale)|San Francisco Caltrain (Townsend at 4th)|2184 |\n+---------------------------------------------+----------------------------------------+-----+\nonly showing top 10 rows\n\n</div>"]}}],"execution_count":10},{"cell_type":"code","source":["# query graph - 2\nstationGraph.edges\\\n  .where(\"src like '%7th%' or dst like '%7th%'\")\\\n  .groupBy(\"src\", \"dst\").count()\\\n  .orderBy(desc(\"count\"))\\\n  .show(10, False)"],"metadata":{},"outputs":[{"metadata":{},"output_type":"display_data","data":{"text/html":["<style scoped>\n  .ansiout {\n    display: block;\n    unicode-bidi: embed;\n    white-space: pre-wrap;\n    word-wrap: break-word;\n    word-break: break-all;\n    font-family: \"Source Code Pro\", \"Menlo\", monospace;;\n    font-size: 13px;\n    color: #555;\n    margin-left: 4px;\n    line-height: 19px;\n  }\n</style>\n<div class=\"ansiout\">+---------------------------------------------+---------------------------------------------+-----+\nsrc                                          |dst                                          |count|\n+---------------------------------------------+---------------------------------------------+-----+\nSan Francisco Caltrain 2 (330 Townsend)      |Townsend at 7th                              |3748 |\nTownsend at 7th                              |San Francisco Caltrain 2 (330 Townsend)      |2734 |\nTownsend at 7th                              |San Francisco Caltrain (Townsend at 4th)     |2192 |\nTownsend at 7th                              |Civic Center BART (7th at Market)            |1844 |\nCivic Center BART (7th at Market)            |Townsend at 7th                              |1765 |\nSan Francisco Caltrain (Townsend at 4th)     |Townsend at 7th                              |1198 |\nTemporary Transbay Terminal (Howard at Beale)|Townsend at 7th                              |834  |\nTownsend at 7th                              |Harry Bridges Plaza (Ferry Building)         |827  |\nSteuart at Market                            |Townsend at 7th                              |746  |\nTownsend at 7th                              |Temporary Transbay Terminal (Howard at Beale)|740  |\n+---------------------------------------------+---------------------------------------------+-----+\nonly showing top 10 rows\n\n</div>"]}}],"execution_count":11},{"cell_type":"code","source":["# create subgraph\ntownAnd7thEdges = stationGraph.edges\\\n  .where(\"src like '%7th%' or dst like '%7th%'\")\nsubgraph = GraphFrame(stationGraph.vertices, townAnd7thEdges)"],"metadata":{},"outputs":[{"metadata":{},"output_type":"display_data","data":{"text/html":["<style scoped>\n  .ansiout {\n    display: block;\n    unicode-bidi: embed;\n    white-space: pre-wrap;\n    word-wrap: break-word;\n    word-break: break-all;\n    font-family: \"Source Code Pro\", \"Menlo\", monospace;;\n    font-size: 13px;\n    color: #555;\n    margin-left: 4px;\n    line-height: 19px;\n  }\n</style>\n<div class=\"ansiout\"></div>"]}}],"execution_count":12},{"cell_type":"code","source":["# define a motif\nmotifs = stationGraph.find(\"(a)-[ab]->(b); (b)-[bc]->(c); (c)-[ca]->(a)\")"],"metadata":{},"outputs":[{"metadata":{},"output_type":"display_data","data":{"text/html":["<style scoped>\n  .ansiout {\n    display: block;\n    unicode-bidi: embed;\n    white-space: pre-wrap;\n    word-wrap: break-word;\n    word-break: break-all;\n    font-family: \"Source Code Pro\", \"Menlo\", monospace;;\n    font-size: 13px;\n    color: #555;\n    margin-left: 4px;\n    line-height: 19px;\n  }\n</style>\n<div class=\"ansiout\"></div>"]}}],"execution_count":13},{"cell_type":"code","source":["# query the motif\nmotifs.selectExpr(\"*\",\n    \"to_timestamp(ab.`Start Date`, 'MM/dd/yyyy HH:mm') as abStart\",\n    \"to_timestamp(bc.`Start Date`, 'MM/dd/yyyy HH:mm') as bcStart\", \n    \"to_timestamp(ca.`Start Date`, 'MM/dd/yyyy HH:mm') as caStart\")\\\n  .where(\"ca.`Bike #` = bc.`Bike #`\").where(\"ab.`Bike #` = bc.`Bike #`\")\\\n  .where(\"a.id != b.id\").where(\"b.id != c.id\")\\\n  .where(\"abStart < bcStart\").where(\"bcStart < caStart\")\\\n  .orderBy(expr(\"cast(caStart as long) - cast(abStart as long)\"))\\\n  .selectExpr(\"a.id\", \"b.id\", \"c.id\", \"ab.`Start Date`\", \"ca.`End Date`\") .limit(5).show(5, False)\n"],"metadata":{},"outputs":[{"metadata":{},"output_type":"display_data","data":{"text/html":["<style scoped>\n  .ansiout {\n    display: block;\n    unicode-bidi: embed;\n    white-space: pre-wrap;\n    word-wrap: break-word;\n    word-break: break-all;\n    font-family: \"Source Code Pro\", \"Menlo\", monospace;;\n    font-size: 13px;\n    color: #555;\n    margin-left: 4px;\n    line-height: 19px;\n  }\n</style>\n<div class=\"ansiout\">+----------------------------------------+----------------------------------------+----------------------------------------+---------------+---------------+\nid                                      |id                                      |id                                      |Start Date     |End Date       |\n+----------------------------------------+----------------------------------------+----------------------------------------+---------------+---------------+\nSan Francisco Caltrain 2 (330 Townsend) |Townsend at 7th                         |San Francisco Caltrain (Townsend at 4th)|5/19/2015 16:09|5/19/2015 16:33|\nHarry Bridges Plaza (Ferry Building)    |2nd at Townsend                         |San Francisco Caltrain (Townsend at 4th)|6/16/2015 8:03 |6/16/2015 8:31 |\nSpear at Folsom                         |Market at 4th                           |San Francisco Caltrain (Townsend at 4th)|7/17/2015 8:47 |7/17/2015 9:15 |\n2nd at Townsend                         |San Francisco Caltrain (Townsend at 4th)|Harry Bridges Plaza (Ferry Building)    |7/20/2015 8:51 |7/20/2015 9:14 |\nSan Francisco Caltrain (Townsend at 4th)|2nd at Townsend                         |Steuart at Market                       |10/8/2014 17:12|10/8/2014 17:42|\n+----------------------------------------+----------------------------------------+----------------------------------------+---------------+---------------+\n\n</div>"]}}],"execution_count":14},{"cell_type":"code","source":["# try PageRank\nranks = stationGraph.pageRank(resetProbability=0.15, maxIter=10)\nranks.vertices.orderBy(desc(\"pagerank\")).select(\"id\", \"pagerank\").show(10, False)"],"metadata":{},"outputs":[{"metadata":{},"output_type":"display_data","data":{"text/html":["<style scoped>\n  .ansiout {\n    display: block;\n    unicode-bidi: embed;\n    white-space: pre-wrap;\n    word-wrap: break-word;\n    word-break: break-all;\n    font-family: \"Source Code Pro\", \"Menlo\", monospace;;\n    font-size: 13px;\n    color: #555;\n    margin-left: 4px;\n    line-height: 19px;\n  }\n</style>\n<div class=\"ansiout\">+----------------------------------------+------------------+\nid                                      |pagerank          |\n+----------------------------------------+------------------+\nSan Jose Diridon Caltrain Station       |4.051504835989957 |\nSan Francisco Caltrain (Townsend at 4th)|3.351183296428704 |\nMountain View Caltrain Station          |2.514390771015558 |\nRedwood City Caltrain Station           |2.3263087713711688|\nSan Francisco Caltrain 2 (330 Townsend) |2.2311442913698567|\nHarry Bridges Plaza (Ferry Building)    |1.8251120118882902|\n2nd at Townsend                         |1.5821217785039197|\nSanta Clara at Almaden                  |1.573007408490752 |\nTownsend at 7th                         |1.568456580534067 |\nEmbarcadero at Sansome                  |1.5414242087748948|\n+----------------------------------------+------------------+\nonly showing top 10 rows\n\n</div>"]}}],"execution_count":15},{"cell_type":"code","source":["# try PageRank in different args\nranks = stationGraph.pageRank(resetProbability=0.15, maxIter=30)\nranks.vertices.orderBy(desc(\"pagerank\")).select(\"id\", \"pagerank\").show(10, False)"],"metadata":{},"outputs":[{"metadata":{},"output_type":"display_data","data":{"text/html":["<style scoped>\n  .ansiout {\n    display: block;\n    unicode-bidi: embed;\n    white-space: pre-wrap;\n    word-wrap: break-word;\n    word-break: break-all;\n    font-family: \"Source Code Pro\", \"Menlo\", monospace;;\n    font-size: 13px;\n    color: #555;\n    margin-left: 4px;\n    line-height: 19px;\n  }\n</style>\n<div class=\"ansiout\">+----------------------------------------+------------------+\nid                                      |pagerank          |\n+----------------------------------------+------------------+\nSan Jose Diridon Caltrain Station       |4.052072395141116 |\nSan Francisco Caltrain (Townsend at 4th)|3.352622194896396 |\nMountain View Caltrain Station          |2.574839281636596 |\nRedwood City Caltrain Station           |2.2856670346026244|\nSan Francisco Caltrain 2 (330 Townsend) |2.232103338946982 |\nHarry Bridges Plaza (Ferry Building)    |1.8259051393525276|\n2nd at Townsend                         |1.5828006485864807|\nSanta Clara at Almaden                  |1.5724877744174566|\nTownsend at 7th                         |1.569118852056774 |\nEmbarcadero at Sansome                  |1.542078316108657 |\n+----------------------------------------+------------------+\nonly showing top 10 rows\n\n</div>"]}}],"execution_count":16},{"cell_type":"code","source":["# try PageRank in different args\nranks = stationGraph.pageRank(resetProbability=0.3, maxIter=10)\nranks.vertices.orderBy(desc(\"pagerank\")).select(\"id\", \"pagerank\").show(10, False)"],"metadata":{},"outputs":[{"metadata":{},"output_type":"display_data","data":{"text/html":["<style scoped>\n  .ansiout {\n    display: block;\n    unicode-bidi: embed;\n    white-space: pre-wrap;\n    word-wrap: break-word;\n    word-break: break-all;\n    font-family: \"Source Code Pro\", \"Menlo\", monospace;;\n    font-size: 13px;\n    color: #555;\n    margin-left: 4px;\n    line-height: 19px;\n  }\n</style>\n<div class=\"ansiout\">+----------------------------------------+------------------+\nid                                      |pagerank          |\n+----------------------------------------+------------------+\nSan Jose Diridon Caltrain Station       |3.5371417576938704|\nSan Francisco Caltrain (Townsend at 4th)|2.9740336222392894|\nMountain View Caltrain Station          |2.2193875586277163|\nRedwood City Caltrain Station           |2.21921974959023  |\nSan Francisco Caltrain 2 (330 Townsend) |2.030909016246817 |\nHarry Bridges Plaza (Ferry Building)    |1.645350121719303 |\n2nd at Townsend                         |1.4587353987337344|\nTownsend at 7th                         |1.4515856862063325|\nEmbarcadero at Sansome                  |1.4344460075806913|\nSanta Clara at Almaden                  |1.4143840602132949|\n+----------------------------------------+------------------+\nonly showing top 10 rows\n\n</div>"]}}],"execution_count":17},{"cell_type":"code","source":["# try PageRank in different args\nranks = stationGraph.pageRank(resetProbability=0.3, maxIter=30)\nranks.vertices.orderBy(desc(\"pagerank\")).select(\"id\", \"pagerank\").show(10, False)"],"metadata":{},"outputs":[{"metadata":{},"output_type":"display_data","data":{"text/html":["<style scoped>\n  .ansiout {\n    display: block;\n    unicode-bidi: embed;\n    white-space: pre-wrap;\n    word-wrap: break-word;\n    word-break: break-all;\n    font-family: \"Source Code Pro\", \"Menlo\", monospace;;\n    font-size: 13px;\n    color: #555;\n    margin-left: 4px;\n    line-height: 19px;\n  }\n</style>\n<div class=\"ansiout\">+----------------------------------------+------------------+\nid                                      |pagerank          |\n+----------------------------------------+------------------+\nSan Jose Diridon Caltrain Station       |3.5372291061359378|\nSan Francisco Caltrain (Townsend at 4th)|2.974121682358048 |\nMountain View Caltrain Station          |2.224029477155645 |\nRedwood City Caltrain Station           |2.2167977045769818|\nSan Francisco Caltrain 2 (330 Townsend) |2.0309676522082185|\nHarry Bridges Plaza (Ferry Building)    |1.6453983875919334|\n2nd at Townsend                         |1.4587770001098306|\nTownsend at 7th                         |1.4516259185779403|\nEmbarcadero at Sansome                  |1.4344860748729693|\nSanta Clara at Almaden                  |1.4143255612096537|\n+----------------------------------------+------------------+\nonly showing top 10 rows\n\n</div>"]}}],"execution_count":18},{"cell_type":"code","source":["# try In-Degree and Out-Degree metrics\ninDeg = stationGraph.inDegrees\ninDeg.orderBy(desc(\"inDegree\")).show(5, False)"],"metadata":{},"outputs":[{"metadata":{},"output_type":"display_data","data":{"text/html":["<style scoped>\n  .ansiout {\n    display: block;\n    unicode-bidi: embed;\n    white-space: pre-wrap;\n    word-wrap: break-word;\n    word-break: break-all;\n    font-family: \"Source Code Pro\", \"Menlo\", monospace;;\n    font-size: 13px;\n    color: #555;\n    margin-left: 4px;\n    line-height: 19px;\n  }\n</style>\n<div class=\"ansiout\">+----------------------------------------+--------+\nid                                      |inDegree|\n+----------------------------------------+--------+\nSan Francisco Caltrain (Townsend at 4th)|34810   |\nSan Francisco Caltrain 2 (330 Townsend) |22523   |\nHarry Bridges Plaza (Ferry Building)    |17810   |\n2nd at Townsend                         |15463   |\nTownsend at 7th                         |15422   |\n+----------------------------------------+--------+\nonly showing top 5 rows\n\n</div>"]}}],"execution_count":19},{"cell_type":"code","source":["# try In-Degree and Out-Degree metrics\ninDeg = stationGraph.inDegrees\ninDeg.orderBy(\"inDegree\").show(5, False)"],"metadata":{},"outputs":[{"metadata":{},"output_type":"display_data","data":{"text/html":["<style scoped>\n  .ansiout {\n    display: block;\n    unicode-bidi: embed;\n    white-space: pre-wrap;\n    word-wrap: break-word;\n    word-break: break-all;\n    font-family: \"Source Code Pro\", \"Menlo\", monospace;;\n    font-size: 13px;\n    color: #555;\n    margin-left: 4px;\n    line-height: 19px;\n  }\n</style>\n<div class=\"ansiout\">+---------------------------+--------+\nid                         |inDegree|\n+---------------------------+--------+\nRedwood City Public Library|98      |\nFranklin at Maple          |100     |\nMezes Park                 |145     |\nSan Mateo County Center    |187     |\nRedwood City Medical Center|230     |\n+---------------------------+--------+\nonly showing top 5 rows\n\n</div>"]}}],"execution_count":20},{"cell_type":"code","source":["# try In-Degree and Out-Degree metrics\noutDeg = stationGraph.outDegrees\noutDeg.orderBy(desc(\"outDegree\")).show(5, False)"],"metadata":{},"outputs":[{"metadata":{},"output_type":"display_data","data":{"text/html":["<style scoped>\n  .ansiout {\n    display: block;\n    unicode-bidi: embed;\n    white-space: pre-wrap;\n    word-wrap: break-word;\n    word-break: break-all;\n    font-family: \"Source Code Pro\", \"Menlo\", monospace;;\n    font-size: 13px;\n    color: #555;\n    margin-left: 4px;\n    line-height: 19px;\n  }\n</style>\n<div class=\"ansiout\">+---------------------------------------------+---------+\nid                                           |outDegree|\n+---------------------------------------------+---------+\nSan Francisco Caltrain (Townsend at 4th)     |26304    |\nSan Francisco Caltrain 2 (330 Townsend)      |21758    |\nHarry Bridges Plaza (Ferry Building)         |17255    |\nTemporary Transbay Terminal (Howard at Beale)|14436    |\nEmbarcadero at Sansome                       |14158    |\n+---------------------------------------------+---------+\nonly showing top 5 rows\n\n</div>"]}}],"execution_count":21},{"cell_type":"code","source":["# what station tends to out\ndegreeRatio = inDeg.join(outDeg, \"id\")\\\n  .selectExpr(\"id\", \"double(inDegree)/double(outDegree) as degreeRatio\")\ndegreeRatio.orderBy(desc(\"degreeRatio\")).show(5, False)\ndegreeRatio.orderBy(\"degreeRatio\").show(5, False)"],"metadata":{},"outputs":[{"metadata":{},"output_type":"display_data","data":{"text/html":["<style scoped>\n  .ansiout {\n    display: block;\n    unicode-bidi: embed;\n    white-space: pre-wrap;\n    word-wrap: break-word;\n    word-break: break-all;\n    font-family: \"Source Code Pro\", \"Menlo\", monospace;;\n    font-size: 13px;\n    color: #555;\n    margin-left: 4px;\n    line-height: 19px;\n  }\n</style>\n<div class=\"ansiout\">+----------------------------------------+------------------+\nid                                      |degreeRatio       |\n+----------------------------------------+------------------+\nRedwood City Medical Center             |1.5333333333333334|\nSan Mateo County Center                 |1.4724409448818898|\nSJSU 4th at San Carlos                  |1.3621052631578947|\nSan Francisco Caltrain (Townsend at 4th)|1.3233728710462287|\nWashington at Kearny                    |1.3086466165413533|\n+----------------------------------------+------------------+\nonly showing top 5 rows\n\n+-------------------------------+------------------+\nid                             |degreeRatio       |\n+-------------------------------+------------------+\nGrant Avenue at Columbus Avenue|0.5180520570948782|\n2nd at Folsom                  |0.5909488686085761|\nPowell at Post (Union Square)  |0.6434241245136186|\nMezes Park                     |0.6839622641509434|\nEvelyn Park and Ride           |0.7413087934560327|\n+-------------------------------+------------------+\nonly showing top 5 rows\n\n</div>"]}}],"execution_count":22},{"cell_type":"code","source":["# try breadth-first search\nstationGraph.bfs(fromExpr=\"id = 'Townsend at 7th'\",\n                toExpr=\"id = 'Spear at Folsom'\", maxPathLength=2).show(10, False)"],"metadata":{},"outputs":[{"metadata":{},"output_type":"display_data","data":{"text/html":["<style scoped>\n  .ansiout {\n    display: block;\n    unicode-bidi: embed;\n    white-space: pre-wrap;\n    word-wrap: break-word;\n    word-break: break-all;\n    font-family: \"Source Code Pro\", \"Menlo\", monospace;;\n    font-size: 13px;\n    color: #555;\n    margin-left: 4px;\n    line-height: 19px;\n  }\n</style>\n<div class=\"ansiout\">+---------------------------------------------------------------------------+------------------------------------------------------------------------------------------------------------------+---------------------------------------------------------------------------+\nfrom                                                                       |e0                                                                                                                |to                                                                         |\n+---------------------------------------------------------------------------+------------------------------------------------------------------------------------------------------------------+---------------------------------------------------------------------------+\n[65, Townsend at 7th, 37.771058, -122.402717, 15, San Francisco, 8/22/2013]|[913371, 663, 8/31/2015 20:10, Townsend at 7th, 65, 8/31/2015 20:21, Spear at Folsom, 49, 405, Subscriber, 94103] |[49, Spear at Folsom, 37.790302, -122.390637, 19, San Francisco, 8/20/2013]|\n[65, Townsend at 7th, 37.771058, -122.402717, 15, San Francisco, 8/22/2013]|[913265, 658, 8/31/2015 19:04, Townsend at 7th, 65, 8/31/2015 19:15, Spear at Folsom, 49, 606, Subscriber, 94608] |[49, Spear at Folsom, 37.790302, -122.390637, 19, San Francisco, 8/20/2013]|\n[65, Townsend at 7th, 37.771058, -122.402717, 15, San Francisco, 8/22/2013]|[911919, 722, 8/31/2015 8:18, Townsend at 7th, 65, 8/31/2015 8:30, Spear at Folsom, 49, 514, Subscriber, 94103]   |[49, Spear at Folsom, 37.790302, -122.390637, 19, San Francisco, 8/20/2013]|\n[65, Townsend at 7th, 37.771058, -122.402717, 15, San Francisco, 8/22/2013]|[910777, 704, 8/29/2015 10:02, Townsend at 7th, 65, 8/29/2015 10:13, Spear at Folsom, 49, 677, Subscriber, 94107] |[49, Spear at Folsom, 37.790302, -122.390637, 19, San Francisco, 8/20/2013]|\n[65, Townsend at 7th, 37.771058, -122.402717, 15, San Francisco, 8/22/2013]|[908994, 1115, 8/27/2015 19:48, Townsend at 7th, 65, 8/27/2015 20:06, Spear at Folsom, 49, 416, Subscriber, 94105]|[49, Spear at Folsom, 37.790302, -122.390637, 19, San Francisco, 8/20/2013]|\n[65, Townsend at 7th, 37.771058, -122.402717, 15, San Francisco, 8/22/2013]|[906912, 892, 8/26/2015 17:58, Townsend at 7th, 65, 8/26/2015 18:12, Spear at Folsom, 49, 283, Subscriber, 94127] |[49, Spear at Folsom, 37.790302, -122.390637, 19, San Francisco, 8/20/2013]|\n[65, Townsend at 7th, 37.771058, -122.402717, 15, San Francisco, 8/22/2013]|[905201, 980, 8/25/2015 19:17, Townsend at 7th, 65, 8/25/2015 19:33, Spear at Folsom, 49, 327, Subscriber, 94103] |[49, Spear at Folsom, 37.790302, -122.390637, 19, San Francisco, 8/20/2013]|\n[65, Townsend at 7th, 37.771058, -122.402717, 15, San Francisco, 8/22/2013]|[904010, 969, 8/25/2015 9:07, Townsend at 7th, 65, 8/25/2015 9:23, Spear at Folsom, 49, 534, Subscriber, 94131]   |[49, Spear at Folsom, 37.790302, -122.390637, 19, San Francisco, 8/20/2013]|\n[65, Townsend at 7th, 37.771058, -122.402717, 15, San Francisco, 8/22/2013]|[903375, 850, 8/24/2015 19:21, Townsend at 7th, 65, 8/24/2015 19:36, Spear at Folsom, 49, 442, Subscriber, 94105] |[49, Spear at Folsom, 37.790302, -122.390637, 19, San Francisco, 8/20/2013]|\n[65, Townsend at 7th, 37.771058, -122.402717, 15, San Francisco, 8/22/2013]|[899944, 910, 8/21/2015 9:59, Townsend at 7th, 65, 8/21/2015 10:14, Spear at Folsom, 49, 371, Customer, 94107]    |[49, Spear at Folsom, 37.790302, -122.390637, 19, San Francisco, 8/20/2013]|\n+---------------------------------------------------------------------------+------------------------------------------------------------------------------------------------------------------+---------------------------------------------------------------------------+\nonly showing top 10 rows\n\n</div>"]}}],"execution_count":23},{"cell_type":"code","source":["# try connected components\nspark.sparkContext .setCheckpointDir(\"/tmp/checkpoints\")\nminGraph = GraphFrame(stationVertices, tripEdges.sample(False, 0.1))\ncc = minGraph.connectedComponents()"],"metadata":{},"outputs":[{"metadata":{},"output_type":"display_data","data":{"text/html":["<style scoped>\n  .ansiout {\n    display: block;\n    unicode-bidi: embed;\n    white-space: pre-wrap;\n    word-wrap: break-word;\n    word-break: break-all;\n    font-family: \"Source Code Pro\", \"Menlo\", monospace;;\n    font-size: 13px;\n    color: #555;\n    margin-left: 4px;\n    line-height: 19px;\n  }\n</style>\n<div class=\"ansiout\"></div>"]}}],"execution_count":24},{"cell_type":"code","source":["cc.where(\"component != 0\").show(5, False)"],"metadata":{},"outputs":[{"metadata":{},"output_type":"display_data","data":{"text/html":["<style scoped>\n  .ansiout {\n    display: block;\n    unicode-bidi: embed;\n    white-space: pre-wrap;\n    word-wrap: break-word;\n    word-break: break-all;\n    font-family: \"Source Code Pro\", \"Menlo\", monospace;;\n    font-size: 13px;\n    color: #555;\n    margin-left: 4px;\n    line-height: 19px;\n  }\n</style>\n<div class=\"ansiout\">+----------+-------------------------------------+---------+-----------+---------+-------------+------------+----------+\nstation_id|id                                   |lat      |long       |dockcount|landmark     |installation|component |\n+----------+-------------------------------------+---------+-----------+---------+-------------+------------+----------+\n33        |Rengstorff Avenue / California Street|37.400241|-122.099076|15       |Mountain View|8/16/2013   |8589934592|\n25        |Stanford in Redwood City             |37.48537 |-122.203288|15       |Redwood City |8/12/2013   |8589934592|\n84        |Ryland Park                          |37.342725|-121.895617|15       |San Jose     |4/9/2014    |8589934592|\n12        |SJSU 4th at San Carlos               |37.332808|-121.883891|19       |San Jose     |8/7/2013    |8589934592|\n16        |SJSU - San Salvador at 9th           |37.333955|-121.877349|15       |San Jose     |8/7/2013    |8589934592|\n+----------+-------------------------------------+---------+-----------+---------+-------------+------------+----------+\nonly showing top 5 rows\n\n</div>"]}}],"execution_count":25},{"cell_type":"code","source":["# try strongly connected components\nscc = minGraph.stronglyConnectedComponents(maxIter=5)\nscc.groupBy(\"component\").count().show(5, False)"],"metadata":{},"outputs":[{"metadata":{},"output_type":"display_data","data":{"text/html":["<style scoped>\n  .ansiout {\n    display: block;\n    unicode-bidi: embed;\n    white-space: pre-wrap;\n    word-wrap: break-word;\n    word-break: break-all;\n    font-family: \"Source Code Pro\", \"Menlo\", monospace;;\n    font-size: 13px;\n    color: #555;\n    margin-left: 4px;\n    line-height: 19px;\n  }\n</style>\n<div class=\"ansiout\">+------------+-----+\ncomponent   |count|\n+------------+-----+\n128849018880|16   |\n8589934592  |19   |\n0           |33   |\n17179869184 |1    |\n317827579904|1    |\n+------------+-----+\n\n</div>"]}}],"execution_count":26},{"cell_type":"code","source":[""],"metadata":{},"outputs":[],"execution_count":27}],"metadata":{"name":"Spark Graph Analytics","notebookId":2322610376084766},"nbformat":4,"nbformat_minor":0}
